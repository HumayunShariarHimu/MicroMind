<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroMind</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon: #00ff41;
            --alert: #ff3e3e;
            --bg: #020502;
            --panel: rgba(0, 30, 0, 0.7);
            --border: rgba(0, 255, 65, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--neon);
            font-family: 'Rajdhani', 'Noto Sans Bengali', sans-serif;
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Boot Screen --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .loader-box { width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--neon); padding: 30px; position: relative; }
        .progress-bar { height: 4px; background: #111; margin: 20px 0; overflow: hidden; }
        #load-fill { width: 0%; height: 100%; background: var(--neon); transition: 0.3s; box-shadow: 0 0 10px var(--neon); }

        /* --- Layout --- */
        .hud-header {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.9); font-family: 'Orbitron'; font-size: 10px;
        }

        .main-container {
            flex: 1; display: grid; grid-template-columns: 1fr;
            padding: 10px; gap: 10px; overflow-y: auto;
            scrollbar-width: none;
        }

        @media (min-width: 1024px) {
            .main-container { grid-template-columns: 320px 1fr 320px; align-items: start; }
        }

        /* --- Video & Canvas --- */
        .viewport-wrapper {
            position: relative; width: 100%; aspect-ratio: 4/3;
            border: 1px solid var(--neon); border-radius: 4px; overflow: hidden;
            background: #000;
        }

        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .mirrored-off { transform: scaleX(1); }
        canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; pointer-events: none; }

        /* --- UI Elements --- */
        .data-card {
            background: var(--panel); border: 1px solid var(--border);
            padding: 12px; margin-bottom: 10px; backdrop-filter: blur(5px);
        }

        .card-title { font-size: 11px; font-family: 'Orbitron'; opacity: 0.7; margin-bottom: 8px; color: var(--neon); }
        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .stat-val { font-weight: bold; color: #fff; font-size: 1.1rem; }

        .ai-verdict-box {
            background: rgba(0, 255, 65, 0.05); border-left: 3px solid var(--neon);
            padding: 15px; min-height: 80px; font-size: 14px; line-height: 1.5; color: #eee;
        }

        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .btn-neon {
            flex: 1; background: transparent; border: 1px solid var(--neon);
            color: var(--neon); padding: 12px; font-family: 'Orbitron';
            font-size: 11px; cursor: pointer; transition: 0.3s;
        }
        .btn-neon:hover { background: rgba(0, 255, 65, 0.1); }
        .btn-neon:active { background: var(--neon); color: #000; }

        /* --- Scanner Line --- */
        .scanner-line {
            position: absolute; width: 100%; height: 2px; background: var(--neon);
            top: 0; left: 0; box-shadow: 0 0 15px var(--neon);
            animation: scan 4s linear infinite; z-index: 5; opacity: 0.5;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

    </style>
</head>
<body>

<div id="boot-screen">
    <div class="loader-box">
        <div style="font-family: 'Orbitron'; font-size: 20px; letter-spacing: 2px;">MicroMind</div>
        <div id="boot-status" style="font-size: 9px; margin-top: 10px; opacity: 0.6;">INITIALIZING CORE...</div>
        <div class="progress-bar"><div id="load-fill"></div></div>
    </div>
</div>

<header class="hud-header">
    <div id="sys-status">● SYSTEM: Active</div>
    <div style="font-size: 16px; color: #fff; letter-spacing: 3px;">MicroMind</div>
    <div id="clock">00:00:00</div>
</header>

<main class="main-container">
    <aside class="left-panel">
        <div class="data-card">
            <div class="card-title">FACIAL ASYMMETRY</div>
            <div class="stat-row"><span>Index:</span> <span id="asym-index" class="stat-val">0.00</span></div>
            <div style="font-size: 10px; opacity: 0.5;">*Asymmetry suggests cognitive load.</div>
        </div>
        <div class="data-card">
            <div class="card-title">BLINK RATE</div>
            <div id="blink-status" class="stat-val" style="color: var(--neon);">MONITORING...</div>
        </div>
        <div class="data-card">
            <div class="card-title">PUPIL ANALYSIS</div>
            <div id="pupil-val" class="stat-val">STABLE</div>
        </div>
    </aside>

    <section class="center-panel">
        <div class="viewport-wrapper" id="vp-container">
            <div class="scanner-line"></div>
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="action-bar">
            <button class="btn-neon" onclick="switchCam()">Switch Camera</button>
            <button class="btn-neon" onclick="location.reload()">Reset System</button>
        </div>
    </section>

    <aside class="right-panel">
        <div class="data-card">
            <div class="card-title">DOMINANT EMOTION</div>
            <div id="main-emotion" style="font-size: 22px; font-weight: bold; color: var(--neon); font-family: 'Orbitron';">...</div>
        </div>
        <div class="ai-verdict-box" id="ai-verdict">
            স্ক্যানিং শুরু করুন...
        </div>
        <div class="data-card" style="margin-top: 10px; border-color: var(--alert);">
            <div class="card-title" style="color: var(--alert);">DECEPTION PROBABILITY</div>
            <div id="lie-meter" style="font-size: 24px; font-weight: bold; color: var(--alert); font-family: 'Orbitron';">0%</div>
        </div>
    </aside>
</main>

<script>
    const video = document.getElementById('video');
    const loadFill = document.getElementById('load-fill');
    const statusText = document.getElementById('boot-status');
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
    
    let useFrontCamera = true;
    let canvas = null;
    let currentStream = null;

    async function init() {
        try {
            statusText.innerText = "LOADING NEURAL NETWORKS (30%)...";
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            loadFill.style.width = "30%";
            
            statusText.innerText = "MAPPING LANDMARKS (60%)...";
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            loadFill.style.width = "60%";
            
            statusText.innerText = "CALIBRATING EMOTIONS (100%)...";
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            loadFill.style.width = "100%";
            
            setTimeout(startCamera, 500);
        } catch (e) {
            statusText.innerText = "HARDWARE ERROR: AI FAILED TO LOAD";
            console.error(e);
        }
    }

    async function startCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: useFrontCamera ? "user" : "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            
            currentStream = stream;
            video.srcObject = stream;
            
            // Mirror flip for front camera
            video.classList.toggle('mirrored-off', !useFrontCamera);

            video.onloadedmetadata = () => {
                document.getElementById('boot-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('boot-screen').style.display = 'none', 500);
                startAnalysis();
            };
        } catch (err) {
            alert("Camera Access Denied!");
        }
    }

    async function startAnalysis() {
        // Create canvas once to avoid memory leaks
        if(!canvas) {
            canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('vp-container').append(canvas);
        }
        
        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            if (video.paused || video.ended) return;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.5 }))
                .withFaceLandmarks()
                .withFaceExpressions();

            const resized = faceapi.resizeResults(detections, displaySize);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (resized.length > 0) {
                const face = resized[0];
                drawHUD(ctx, face);
                analyzePsychology(face);
            }
        }, 150);
    }

    function drawHUD(ctx, face) {
        const { box } = face.detection;
        ctx.strokeStyle = '#00ff41';
        ctx.lineWidth = 2;
        
        // Custom UI Corners
        const len = 20;
        ctx.beginPath();
        // Top Left
        ctx.moveTo(box.x, box.y + len); ctx.lineTo(box.x, box.y); ctx.lineTo(box.x + len, box.y);
        // Top Right
        ctx.moveTo(box.right - len, box.y); ctx.lineTo(box.right, box.y); ctx.lineTo(box.right, box.y + len);
        // Bottom Left
        ctx.moveTo(box.x, box.bottom - len); ctx.lineTo(box.x, box.bottom); ctx.lineTo(box.x + len, box.bottom);
        // Bottom Right
        ctx.moveTo(box.right - len, box.bottom); ctx.lineTo(box.right, box.bottom); ctx.lineTo(box.right, box.bottom - len);
        ctx.stroke();

        // Landmarks
        faceapi.draw.drawFaceLandmarks(canvas, face);
    }

    function analyzePsychology(data) {
        const exps = data.expressions;
        const topExp = Object.keys(exps).reduce((a, b) => exps[a] > exps[b] ? a : b);
        const landmarks = data.landmarks;

        // 1. Asymmetry Index
        const leftEye = landmarks.getLeftEye();
        const rightEye = landmarks.getRightEye();
        const asym = Math.abs(leftEye[0].y - rightEye[0].y).toFixed(2);
        document.getElementById('asym-index').innerText = asym;

        // 2. Emotion Text Update
        document.getElementById('main-emotion').innerText = topExp.toUpperCase();

        // 3. Verdict Logic (Original)
        let verdict = "";
        let lieProb = 0;

        if (topExp === 'happy' && exps.happy > 0.8) {
            verdict = "আপনার হাসি স্বাভাবিক এবং ইতিবাচক (Duchenne Smile এর সম্ভাবনা বেশি)।";
            lieProb = 5;
        } else if (topExp === 'neutral' && asym > 5) {
            verdict = "আপনার মুখে এক ধরণের 'কগনিটিভ ডিসোনেন্স' বা মানসিক দ্বন্দ্বের ছাপ লক্ষ্য করা যাচ্ছে।";
            lieProb = 45;
        } else if (topExp === 'sad' || topExp === 'fearful') {
            verdict = "আপনি সম্ভবত নেতিবাচক আবেগ দমন করার চেষ্টা করছেন।";
            lieProb = 30;
        } else if (asym > 8) {
            verdict = "মুখের দুই অংশের অমিল পাওয়া গেছে। এটি কোনো সত্য আবেগ লুকানোর 'মাইক্রো-এক্সপ্রেশন' হতে পারে।";
            lieProb = 75;
        } else {
            verdict = "সিস্টেম তথ্য বিশ্লেষণ করছে... আপনার বর্তমান শারীরিক অবস্থা স্থিতিশীল।";
            lieProb = 10;
        }

        document.getElementById('ai-verdict').innerText = verdict;
        document.getElementById('lie-meter').innerText = lieProb + "%";
    }

    function switchCam() {
        useFrontCamera = !useFrontCamera;
        startCamera();
    }

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    window.onload = init;
</script>

</body>
</html>
