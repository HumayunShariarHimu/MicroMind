<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroMind</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon: #00ff41;
            --bg: #020502;
            --panel: rgba(0, 20, 0, 0.8);
            --border: rgba(0, 255, 65, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg);
            color: var(--neon);
            font-family: 'Rajdhani', 'Noto Sans Bengali', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* মোবাইল স্ক্রিন লক রাখতে */
        }

        /* --- বুট স্ক্রিন (মডেল লোডিং) --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }

        .loader-box {
            width: 250px; padding: 20px; border: 1px solid var(--neon);
            text-align: center; position: relative;
        }

        .progress-container {
            width: 100%; height: 5px; background: #111; margin: 15px 0;
            border-radius: 10px; overflow: hidden;
        }

        #load-bar { width: 0%; height: 100%; background: var(--neon); transition: 0.3s; }

        /* --- মেইন লেআউট --- */
        .hud-header {
            padding: 10px 15px; background: #000; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Orbitron'; font-size: 10px;
        }

        .main-grid {
            flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 10px;
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
            .main-grid { display: grid; grid-template-columns: 280px 1fr 280px; }
        }

        /* --- ভিডিও ফ্রেম (পারফেক্ট রেসপন্সিভ) --- */
        .viewport-container {
            position: relative; width: 100%; aspect-ratio: 4/3;
            background: #000; border: 1px solid var(--neon);
            border-radius: 8px; overflow: hidden;
            box-shadow: 0 0 20px rgba(0,255,65,0.1);
        }

        @media (min-width: 1024px) { .viewport-container { aspect-ratio: 16/9; } }

        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }

        /* --- সাইড কার্ডস --- */
        .card {
            background: var(--panel); border: 1px solid var(--border);
            padding: 12px; border-radius: 4px; margin-bottom: 10px;
        }

        .card-header { font-size: 11px; font-family: 'Orbitron'; margin-bottom: 10px; opacity: 0.7; }

        .stat-val { font-size: 18px; font-weight: bold; color: #fff; }

        /* --- কন্ট্রোলস --- */
        .controls { display: flex; gap: 10px; margin-top: 5px; }
        .btn {
            flex: 1; background: transparent; border: 1px solid var(--neon);
            color: var(--neon); padding: 10px; font-family: 'Orbitron';
            font-size: 9px; cursor: pointer; border-radius: 4px;
        }
        .btn:active { background: var(--neon); color: #000; }

    </style>
</head>
<body>

<div id="boot-screen">
    <div class="loader-box">
    	<h1 style="font-family: 'Orbitron'; font-size: 15px; margin-bottom: 10px;">MicroMind</h1>
        <h2 style="font-family: 'Orbitron'; font-size: 8px; margin-bottom: 10px;">Intilizing System</h2>
        <div id="status-text" style="font-size: 10px; margin-bottom: 5px;">0%</div>
        <div class="progress-container"><div id="load-bar"></div></div>
        <p style="font-size: 9px; opacity: 0.5;">DO NOT CLOSE THE BROWSER</p>
    </div>
</div>

<header class="hud-header">
    <div>SYSTEM: Ready</div>
    <div style="font-size: 16px; letter-spacing: 2px;">MicroMind</div>
    <div id="clock">00:00:00</div>
</header>

<main class="main-grid">
    <aside>
        <div class="card">
            <div class="card-header">BIOMETRIC ASYMMETRY</div>
            <div id="asym-val" class="stat-val">0.00</div>
        </div>
        <div class="card">
            <div class="card-header">PRIMARY EMOTION</div>
            <div id="emo-val" class="stat-val" style="color: var(--neon);">WAITING...</div>
        </div>
    </aside>

    <section>
        <div class="viewport-container" id="video-box">
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="controls">
            <button class="btn" onclick="switchCam()">SWITCH CAMERA</button>
            <button class="btn" onclick="location.reload()">RELOAD AI</button>
        </div>
    </section>

    <aside>
        <div class="card" style="min-height: 120px;">
            <div class="card-header">AI VERDICT</div>
            <div id="verdict-txt" style="font-size: 14px; line-height: 1.5; color: #fff;">
                ক্যামেরা ফিড অ্যানালাইজ করা হচ্ছে...
            </div>
        </div>
    </aside>
</main>

<script>
    const video = document.getElementById('video');
    const loadBar = document.getElementById('load-bar');
    const statusText = document.getElementById('status-text');
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
    
    let useFrontCamera = true;
    let canvas = null;

    // ১. প্রফেশনাল মডেল লোডার (প্রগ্রেস বার সহ)
    async function loadAISystems() {
        try {
            const models = [
                { name: 'Face Detector', load: faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL) },
                { name: 'Face Landmarks', load: faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL) },
                { name: 'Expression Engine', load: faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL) }
            ];

            for(let i=0; i < models.length; i++) {
                await models[i].load;
                let percent = Math.round(((i + 1) / models.length) * 100);
                loadBar.style.width = percent + '%';
                statusText.innerText = `LOADING ${models[i].name}... ${percent}%`;
            }

            startVideo();
        } catch (err) {
            statusText.innerText = "ERROR: INTERNET CONNECTION FAILED";
            console.error(err);
        }
    }

    // ২. ভিডিও স্টার্ট (Error Handling সহ)
    async function startVideo() {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }

        const constraints = {
            video: { 
                facingMode: useFrontCamera ? "user" : "environment",
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                document.getElementById('boot-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                    initAnalysis();
                }, 800);
            };
        } catch (err) {
            alert("ক্যামেরা শুরু করা যাচ্ছে না। দয়া করে নিশ্চিত করুন অন্য কোনো অ্যাপ ক্যামেরা ব্যবহার করছে না।");
        }
    }

    // ৩. রেসপন্সিভ ক্যানভাস এবং অ্যানালাইসিস
    async function initAnalysis() {
        if(canvas) canvas.remove();
        
        canvas = faceapi.createCanvasFromMedia(video);
        document.getElementById('video-box').append(canvas);
        
        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions();

            const resizedResults = faceapi.resizeResults(detections, displaySize);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (resizedResults.length > 0) {
                // কাস্টম বক্স ড্র
                resizedResults.forEach(det => {
                    const box = det.detection.box;
                    ctx.strokeStyle = '#00ff41';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                });
                updateBiometrics(resizedResults[0]);
            }
        }, 150); // স্মুথ ফাস্ট আপডেট
    }

    function updateBiometrics(data) {
        const exps = data.expressions;
        const topExp = Object.keys(exps).reduce((a, b) => exps[a] > exps[b] ? a : b);
        
        // Asymmetry
        const marks = data.landmarks.getLeftEye();
        const asym = Math.abs(marks[0].y - marks[3].y).toFixed(2);
        
        document.getElementById('asym-val').innerText = asym;
        document.getElementById('emo-val').innerText = topExp.toUpperCase();

        const messages = {
            happy: "আপনার মানসিক অবস্থা ইতিবাচক। ব্রেইন ফাংশন শান্ত আছে।",
            neutral: "আপনি স্থির অবস্থায় আছেন। কোনো স্ট্রেস নেই।",
            sad: "আপনাকে কিছুটা বিমর্ষ মনে হচ্ছে। পর্যাপ্ত বিশ্রাম প্রয়োজন।",
            angry: "টেনশন বা রাগের লক্ষণ পাওয়া গেছে। শান্ত হওয়ার চেষ্টা করুন।"
        };
        document.getElementById('verdict-txt').innerText = messages[topExp] || "আবেগ বিশ্লেষণ করা হচ্ছে...";
    }

    function switchCam() {
        useFrontCamera = !useFrontCamera;
        startVideo();
    }

    // টাইম এবং রিসাইজ হ্যান্ডলিং
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
    window.addEventListener('resize', () => initAnalysis());
    window.onload = loadAISystems;

</script>
</body>
</html>
