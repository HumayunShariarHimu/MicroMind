<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroMind | Bio-Neural Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --cyan: #00f2ff; --green: #00ff41; --red: #ff0055; --bg: #000a0f; }
        body { background: var(--bg); color: var(--cyan); font-family: 'Orbitron', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        #sidebar { width: 340px; background: rgba(0, 15, 25, 0.95); border-right: 1px solid var(--cyan); padding: 20px; display: flex; flex-direction: column; z-index: 100; backdrop-filter: blur(10px); }
        
        #display { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        
        /* ক্যানভাসের উপরে ক্যামেরা ফিড দেখা যাবে */
        canvas#face-canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        video#input_video { display: none; /* ভিডিও ট্যাগটি হাইড থাকবে কিন্তু মিডিয়াপাইপের ইনপুট হিসেবে কাজ করবে */ }

        .mode-card { border: 1px solid rgba(0, 242, 255, 0.2); padding: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.02); }
        .active-mode { border-color: var(--cyan); background: rgba(0, 242, 255, 0.15); box-shadow: 0 0 10px var(--cyan); }

        .result-hud { position: absolute; bottom: 80px; left: 20px; right: 20px; background: rgba(0,10,20,0.85); border: 1px solid var(--cyan); padding: 15px; border-radius: 4px; z-index: 50; }
        .btn-trigger { width: 100%; padding: 18px; background: transparent; border: 2px solid var(--green); color: var(--green); font-weight: bold; font-family: 'Orbitron'; cursor: pointer; margin-top: auto; letter-spacing: 2px; }
        .btn-trigger:active { background: var(--green); color: #000; }
        .triggering-active { border-color: var(--red) !important; color: var(--red) !important; box-shadow: 0 0 20px var(--red); }

        footer { background: #000; padding: 10px; text-align: center; border-top: 1px solid rgba(0, 242, 255, 0.1); font-size: 0.7rem; color: var(--cyan); z-index: 101; }

        @media (max-width: 900px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--cyan); padding: 15px; }
            .mode-card p { display: none; }
            .mode-container { display: flex; gap: 8px; overflow-x: auto; }
            .mode-card { min-width: 110px; margin: 0; padding: 10px; font-size: 0.6rem; text-align: center; }
        }
    </style>
</head>
<body>

<div id="main-container">
    <div id="sidebar">
        <div style="text-align:center; margin-bottom:20px;">
            <h1 style="margin:0; font-size: 1.4rem; letter-spacing:3px;">MICROMIND</h1>
            <small style="color:var(--green)">NEURAL CORE V4.0</small>
        </div>

        <div class="mode-container">
            <div id="mouse-btn" class="mode-card" onclick="selectMode('mouse')"><b>USB MOUSE</b></div>
            <div id="camera-btn" class="mode-card active-mode" onclick="selectMode('camera')"><b>OPTIC CAM</b></div>
            <div id="heart-btn" class="mode-card" onclick="selectMode('heartbeat')"><b>BIO PULSE</b></div>
        </div>

        <div style="height: 80px; margin: 20px 0;"><canvas id="miniChart"></canvas></div>
        
        <button id="trigger-btn" class="btn-trigger" onclick="startTrigger()">START TRIGGERING</button>
    </div>

    <div id="display">
        <video id="input_video" playsinline></video>
        <canvas id="face-canvas"></canvas>

        <div class="result-hud">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="font-size:0.6rem; opacity:0.6;">PSYCHOLOGICAL VERDICT:</span><br>
                    <b id="verdict" style="font-size:1.1rem; color:var(--green)">INITIALIZING...</b>
                </div>
                <div style="text-align:right;">
                    <span style="font-size:0.6rem; opacity:0.6;">STRESS SCORE:</span><br>
                    <b id="score" style="font-size:1.4rem;">00</b>%
                </div>
            </div>
            <div id="mind-state" style="font-size:0.7rem; margin-top:10px; border-top:1px solid rgba(0,242,255,0.1); padding-top:8px; color:#fff;">
                ক্যামেরা এবং সেন্সর কানেক্ট করুন।
            </div>
        </div>
    </div>
</div>

<footer>MicroMind © Humayun Shariar Himu</footer>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('face-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const triggerBtn = document.getElementById('trigger-btn');

    let currentMode = 'camera', isTriggered = false, mouseJitter = 0, baselineJitter = 1.0;

    // ১. স্টার্ট ট্রিগারিং ফাংশন
    function startTrigger() {
        console.log("Trigger Clicked!");
        isTriggered = true;
        triggerBtn.classList.add('triggering-active');
        triggerBtn.innerText = "SENSING DEPTH...";
        
        setTimeout(() => {
            isTriggered = false;
            triggerBtn.classList.remove('triggering-active');
            triggerBtn.innerText = "START TRIGGERING";
        }, 4000);
    }

    // ২. মোড সিলেকশন
    function selectMode(m) {
        currentMode = m;
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active-mode'));
        document.getElementById(m + '-btn').classList.add('active-mode');
    }

    // মাউস ট্রেমর সেন্সিং
    document.onmousemove = (e) => { mouseJitter = Math.sqrt(e.movementX**2 + e.movementY**2); };

    // ৩. গ্রাফ সেটআপ
    const chart = new Chart(document.getElementById('miniChart'), {
        type: 'line',
        data: { labels: Array(20).fill(''), datasets: [{ data: [], borderColor: '#00f2ff', borderWidth: 1, pointRadius: 0, tension: 0.4 }] },
        options: { maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false } } }
    });

    // ৪. ফেস মেশ সেটআপ
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

    faceMesh.onResults(onResults);

    function onResults(results) {
        canvasElement.width = videoElement.videoWidth; // ক্যানভাসের সাইজ ভিডিওর সাথে সিঙ্ক করা হয়েছে
        canvasElement.height = videoElement.videoHeight;
        
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // ক্যানভাসের উপর ভিডিও ফ্রেম আঁকা
        // transform: scaleX(-1) CSS দিয়ে করা হয়েছে, তাই এখানে আর অতিরিক্ত স্কেলিং দরকার নেই
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        // ফেস ল্যান্ডমার্ক ড্র করা
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];
            
            canvasCtx.fillStyle = currentMode === 'heartbeat' ? "#ff0055" : "#00f2ff";
            for (const point of landmarks) {
                // এখানে আর মিরর ট্রান্সফরমেশন দরকার নেই কারণ CSS দিয়ে ভিডিওতেই মিরর করা হয়েছে
                let x = point.x * canvasElement.width;
                let y = point.y * canvasElement.height;
                canvasCtx.fillRect(x, y, 1.5, 1.5); // ছোট ডট
            }

            // ব্যাকএন্ড ভ্যালু ক্যালকুলেশন
            dataToSend.brow_dist = Math.abs(landmarks[10].y - landmarks[151].y);
            dataToSend.eye_ratio = Math.abs(landmarks[159].y - landmarks[145].y);
            dataToSend.mouth_tension = Math.abs(landmarks[13].y - landmarks[14].y);
        }

        canvasCtx.restore();

        let dataToSend = {
            baseline_jitter: baselineJitter,
            current_jitter: mouseJitter,
            brow_dist: 0.5, eye_ratio: 0.5, mouth_tension: 0.1, // ডিফল্ট মান
            pulse_val: (currentMode === 'heartbeat' || currentMode === 'mouse') ? mouseJitter : Math.random(),
            mode: currentMode,
            is_triggered: isTriggered
        };

        // ৫. ব্যাকএন্ডে ডেটা পাঠানো (Vercel-এ API URL ঠিক থাকতে হবে)
        fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataToSend)
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('verdict').innerText = data.verdict;
            document.getElementById('score').innerText = Math.round(data.score);
            document.getElementById('mind-state').innerText = data.mind_state;
            
            chart.data.datasets[0].data.push(data.score);
            if(chart.data.datasets[0].data.length > 20) chart.data.datasets[0].data.shift();
            chart.update('none');
            baselineJitter = (baselineJitter * 0.9) + (mouseJitter * 0.1);
        }).catch(e => {
            // console.error("Backend error:", e);
            document.getElementById('mind-state').innerText = "ব্যাকএন্ড সংযোগে সমস্যা। সার্ভার চালু আছে কি না দেখুন।";
        });
    }

    // ৬. ক্যামেরা পারমিশন ও স্টার্ট
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;
            videoElement.onloadedmetadata = () => { // ভিডিও লোড হলে ক্যানভাসের সাইজ সেট হবে
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                videoElement.play();
                requestAnimationFrame(predict);
            };
            
            async function predict() {
                if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                    await faceMesh.send({image: videoElement});
                }
                requestAnimationFrame(predict);
            }
        } catch (err) {
            alert("ক্যামেরা এক্সেস পাওয়া যায়নি! দয়া করে ব্রাউজারে ক্যামেরা পারমিশন চেক করুন এবং পেজ রিফ্রেশ করুন।");
            console.error("Camera access error:", err);
            document.getElementById('mind-state').innerText = "ক্যামেরা এক্সেস পাওয়া যায়নি।";
        }
    }

    window.onload = startCamera;
</script>
</body>
</html>

